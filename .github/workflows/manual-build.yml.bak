# To trigger via rest api:
# curl -H "Authorization: token $GITHUB_TOKEN" -d "{\"ref\": \"your-branch-here\"}" https://api.github.com/repos/djellemah/jch/actions/workflows/build.yml/dispatches

name: run tests then build release

# on:
#   workflow_dispatch: {}
#   push:
#     tags: v*
#     branches: [test-build]
#   pull_request: {}

jobs:
  build:
    runs-on: ubuntu-latest

    env: {}

    steps:
    - uses: actions/checkout@v4

    - name: set up git credentials for cargo
      run: |
        mkdir -p $XDG_CONFIG_HOME/git
        echo https://${{ secrets.ACTION_USER }}:${{ secrets.ACTION_TOKEN }}@github.com > $XDG_CONFIG_HOME/git/credentials
        git config --global credential.helper store
        git config --global --add credential.https://github.com.helper store
        git config --global --add credential.https://github.com.username ${{ secrets.ACTION_USER }}

    - name: cache setup
      uses: Swatinem/rust-cache@v2

    - run: cargo build --tests

  release:
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    runs-on: ubuntu-latest
    needs: build

    steps:
    - uses: actions/checkout@v4

    - name: setup cache
      uses: Swatinem/rust-cache@v2

    - run: cargo build --tests

    - name: package
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      env:
        GITHUB_TOKEN: ${{ secrets.ACTION_TOKEN }}
      with:
        files: target/release/jch
